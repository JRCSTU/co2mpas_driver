<html>
 <body>
  <div>
   <input onclick="window.history.back()" type="button" value="Back"/>
   <input onclick="window.history.forward()" type="button" value="Forward"/>
  </div>
  <html>
   <body>
    <div class="highlight" style="background: #f8f8f8">
     <pre style="line-height: 125%"><span></span><span style="color: #AA22FF">@sh</span><span style="color: #666666">.</span>add_function(dsp, outputs<span style="color: #666666">=</span>[<span style="color: #BA2121">'Start'</span>, <span style="color: #BA2121">'Stop'</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_start_stop</span>(vehicle_max_speed, speed_per_gear, poly_spline):
    <span style="color: #BA2121; font-style: italic">"""</span>
<span style="color: #BA2121; font-style: italic">    Calculate Speed boundaries for each gear.</span>

<span style="color: #BA2121; font-style: italic">    :param gear_box_ratios:</span>
<span style="color: #BA2121; font-style: italic">        Gear box ratios.</span>
<span style="color: #BA2121; font-style: italic">    :type gear_box_ratios: list</span>

<span style="color: #BA2121; font-style: italic">    :param vehicle_max_speed:</span>
<span style="color: #BA2121; font-style: italic">        Vehicle maximum speed.</span>
<span style="color: #BA2121; font-style: italic">    :type vehicle_max_speed: int</span>

<span style="color: #BA2121; font-style: italic">    :param speed_per_gear:</span>
<span style="color: #BA2121; font-style: italic">        Speed per gear.</span>
<span style="color: #BA2121; font-style: italic">    :type speed_per_gear: numpy.array</span>

<span style="color: #BA2121; font-style: italic">    :param acc_per_gear:</span>
<span style="color: #BA2121; font-style: italic">        Acceleration per gear.</span>
<span style="color: #BA2121; font-style: italic">    :type acc_per_gear: numpy.array</span>

<span style="color: #BA2121; font-style: italic">    :param poly_spline:</span>
<span style="color: #BA2121; font-style: italic">        Poly spline.</span>
<span style="color: #BA2121; font-style: italic">    :type poly_spline: list</span>

<span style="color: #BA2121; font-style: italic">    :return:</span>
<span style="color: #BA2121; font-style: italic">        Start and Stop for each gear.</span>
<span style="color: #BA2121; font-style: italic">    :rtype: numpy.array, numpy.array</span>
<span style="color: #BA2121; font-style: italic">    """</span>
    v <span style="color: #666666">=</span> np<span style="color: #666666">.</span>asarray(speed_per_gear)
    <span style="color: #408080; font-style: italic"># Ensure that a higher gear starts from higher speed.</span>
    <span style="color: #008000; font-weight: bold">assert</span> (v[:<span style="color: #666666">-1</span>, <span style="color: #666666">0</span>] <span style="color: #666666">&lt;</span> v[<span style="color: #666666">1</span>:, <span style="color: #666666">0</span>])<span style="color: #666666">.</span>all(), <span style="color: #BA2121">"Incoherent shifting point (vi &lt; vi1)!"</span>

    start, stop <span style="color: #666666">=</span> v[:, <span style="color: #666666">0</span>]<span style="color: #666666">.</span>copy(), np<span style="color: #666666">.</span>minimum(v[:, <span style="color: #666666">-1</span>], vehicle_max_speed)
    start[<span style="color: #666666">0</span>], index <span style="color: #666666">=</span> <span style="color: #666666">0</span>, np<span style="color: #666666">.</span>maximum(<span style="color: #666666">0</span>, np<span style="color: #666666">.</span>arange(v<span style="color: #666666">.</span>shape[<span style="color: #666666">1</span>]) <span style="color: #666666">-</span> <span style="color: #666666">1</span>)

    <span style="color: #408080; font-style: italic"># Find where the curve of each gear cuts the next one.</span>
    b, _min <span style="color: #666666">=</span> v[:<span style="color: #666666">-1</span>] <span style="color: #666666">&gt;</span> v[<span style="color: #666666">1</span>:, <span style="color: #666666">0</span>, <span style="color: #008000; font-weight: bold">None</span>], <span style="color: #008000; font-weight: bold">lambda</span> <span style="color: #666666">*</span>a: np<span style="color: #666666">.</span>min(a)
    <span style="color: #008000; font-weight: bold">for</span> i, (_v, (ps0, ps1)) <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(<span style="color: #008000">zip</span>(v[:<span style="color: #666666">-1</span>], sh<span style="color: #666666">.</span>pairwise(poly_spline))):
        stop[i] <span style="color: #666666">=</span> _min(stop[i], <span style="color: #666666">*</span>_v[index[b[i] <span style="color: #666666">&amp;</span> (ps1(_v) <span style="color: #666666">&gt;</span> ps0(_v))]])

    <span style="color: #008000; font-weight: bold">return</span> start, stop
</pre>
    </div>
   </body>
  </html>
 </body>
</html>